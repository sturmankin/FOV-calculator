<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SMOKERs FOV Calculator</title>

<style>
html, body{
  height:100%;
  overflow:hidden; /* prevent scroll/rubber-band */
}

body{
  margin:0;
  background:#000;
}

/* Poster container */
.poster{
  position:fixed;
  inset:0;
  margin:auto;

  width:min(94vw, 860px);
  aspect-ratio: 1024 / 1536;

  background:url("bgmm.png") center/cover no-repeat;
  overflow:hidden;
}

/* Soft dark fades under inputs */
.shadeLeft{
  position:absolute;
  left:21%;
  top:74.2%;
  width:34%;
  height:4.8%;
  pointer-events:none;
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.30) 0%,
    rgba(0,0,0,0.20) 45%,
    rgba(0,0,0,0.0) 85%
  );
}

.shadeRight{
  position:absolute;
  left:54%;
  top:74.2%;
  width:34%;
  height:4.8%;
  pointer-events:none;
  background: radial-gradient(
    ellipse at center,
    rgba(0,0,0,0.30) 0%,
    rgba(0,0,0,0.20) 45%,
    rgba(0,0,0,0.0) 85%
  );
}

/* Inputs + button overlays */
.hit{
  position:absolute;
  border:0;
  outline:0;
  background:transparent;

  color:#ffffff;
  -webkit-text-fill-color:#ffffff;
  caret-color:#ffffff;

  font-family:-apple-system, system-ui, sans-serif;
  font-weight:1000;
  font-size:28px;
  text-align:center;

  padding:0;
  margin:0;

  /* Clean outline using shadow (no text-stroke artifacts) */
  text-shadow:
    -1px 0 #000,
     1px 0 #000,
     0 -1px #000,
     0  1px #000,
     0  3px 0 rgba(0,0,0,0.8);
}

.hit:focus{
  box-shadow:0 0 0 3px rgba(255,255,255,0.2);
  border-radius:12px;
}

/* Result in skull eyes */
.result{
  position:absolute;
  font-family:-apple-system, system-ui, sans-serif;
  font-weight:1000;
  color:#ffffff;

  text-shadow:
    -2px 0 #000,
     2px 0 #000,
     0 -2px #000,
     0  2px #000,
     0  4px 0 rgba(0,0,0,0.85);

  letter-spacing:-0.5px;
  pointer-events:none;
  text-align:center;
  transition:transform 0.15s ease;
}

/* Mobile tweak */
@media (max-width:420px){
  .hit{ font-size:20px; }
}

/* --- Fly overlay (SPRITESHEET) --- */
/* Put fly_sheet.png in the same folder as this HTML */
#fly{
  position:absolute;
  left:50%;
  top:50%;
  width:140px;              /* scale: tweak */
  height:140px;             /* keep square for simplicity */
  pointer-events:none;
  z-index:9999;

  background-image:url("fly_sheet.png");
  background-repeat:no-repeat;

  /* 4 columns x 2 rows => show single frame sized 1/4 by 1/2 of sheet */
  background-size:400% 200%;
  background-position:0% 0%;

  /* walk cycle */
  animation: flyFrames 0.72s steps(8) infinite;

  /* smoother movement */
  will-change: transform, left, top;
  transform: translate(-50%,-50%);
  filter: drop-shadow(0 6px 6px rgba(0,0,0,0.25));
}

/* 8 frames total: 4 across then next row */
@keyframes flyFrames{
  0%   { background-position:   0%      0%; }
  12.5%{ background-position:  33.333%  0%; }
  25%  { background-position:  66.666%  0%; }
  37.5%{ background-position: 100%      0%; }
  50%  { background-position:   0%    100%; }
  62.5%{ background-position:  33.333%100%; }
  75%  { background-position:  66.666%100%; }
  87.5%{ background-position: 100%    100%; }
  100% { background-position:   0%      0%; }
}

/* Optional: smaller on phones */
@media (max-width:420px){
  #fly{ width:110px; height:110px; }
}
</style>
</head>

<body>

<div class="poster">

  <!-- Soft shading under inputs -->
  <div class="shadeLeft"></div>
  <div class="shadeRight"></div>

  <!-- DISTANCE -->
  <input id="distance" class="hit"
    inputmode="numeric" pattern="[0-9]*" maxlength="4"
    style="left:21%; top:74.8%; width:34%; height:4.8%;" />

  <!-- WIDTH -->
  <input id="width" class="hit"
    inputmode="numeric" pattern="[0-9]*" maxlength="4"
    style="left:54%; top:74.8%; width:34%; height:4.8%;" />

  <!-- CALCULATE (invisible button area) -->
  <button id="calcBtn" class="hit"
    style="left:20%; top:81.5%; width:60%; height:7%; cursor:pointer;">
  </button>

  <!-- RESULT -->
  <div id="result" class="result"
    style="left:33%; top:14%; width:34%; font-size:56px;">
  </div>

  <!-- FLY -->
  <div id="fly" aria-hidden="true"></div>

</div>

<script>
const distEl = document.getElementById("distance");
const widthEl = document.getElementById("width");
const resultEl = document.getElementById("result");
const calcBtn = document.getElementById("calcBtn");

function enforce4Digits(el){
  el.value = (el.value || "").replace(/\D+/g, "").slice(0,4);
}

/* Make iPhone “jump” consistent: center the focused field */
function keepInView(el){
  setTimeout(() => {
    try{
      el.scrollIntoView({ block:"center", inline:"nearest" });
    }catch(e){}
  }, 50);
}

distEl.addEventListener("focus", () => keepInView(distEl));
widthEl.addEventListener("focus", () => keepInView(widthEl));

distEl.addEventListener("input", ()=>enforce4Digits(distEl));
widthEl.addEventListener("input", ()=>enforce4Digits(widthEl));

function calculate(){
  enforce4Digits(distEl);
  enforce4Digits(widthEl);

  const D = parseFloat(distEl.value);
  const W = parseFloat(widthEl.value);

  if(!isFinite(D) || !isFinite(W) || D<=0 || W<=0){
    resultEl.textContent="";
    return;
  }

  const angle = 2 * Math.atan((W/2)/D) * 180 / Math.PI;
  resultEl.textContent = angle.toFixed(2) + "°";

  resultEl.style.transform="scale(1.15)";
  setTimeout(()=> resultEl.style.transform="scale(1)",140);
}

calcBtn.addEventListener("click", calculate);

[distEl,widthEl].forEach(el=>{
  el.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") calculate();
  });
});


/* ==========================
   Fly random walk controller
   ========================== */

const posterEl = document.querySelector(".poster");
const flyEl = document.getElementById("fly");

function rand(a,b){ return a + Math.random()*(b-a); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

let state = {
  x: 0.5, y: 0.5,       // normalized 0..1 within poster
  segT: 0,
  segDur: 2.5,
  pause: 0,
  p0: null, p1: null, p2: null, p3: null,
  lastTime: performance.now()
};

function getPosterBox(){
  return posterEl.getBoundingClientRect();
}

function makeSegment(){
  const box = getPosterBox();

  // keep inside safe margins (in px)
  const margin = Math.min(box.width, box.height) * 0.10;

  // current point in px
  const x0 = state.x * box.width;
  const y0 = state.y * box.height;

  // new target in px
  const x3 = rand(margin, box.width - margin);
  const y3 = rand(margin, box.height - margin);

  // direction and length
  const dx = x3 - x0;
  const dy = y3 - y0;
  const d = Math.hypot(dx, dy) || 1;

  // perpendicular for sideways "sway" of curve
  const nx = -dy / d;
  const ny = dx / d;

  // control points roughly along the line + sideways noise
  const c1 = rand(0.20, 0.35);
  const c2 = rand(0.65, 0.80);
  const sway1 = rand(-0.25, 0.25) * d;
  const sway2 = rand(-0.25, 0.25) * d;

  const x1 = x0 + dx * c1 + nx * sway1;
  const y1 = y0 + dy * c1 + ny * sway1;
  const x2 = x0 + dx * c2 + nx * sway2;
  const y2 = y0 + dy * c2 + ny * sway2;

  state.p0 = {x:x0,y:y0};
  state.p1 = {x:clamp(x1, margin, box.width-margin), y:clamp(y1, margin, box.height-margin)};
  state.p2 = {x:clamp(x2, margin, box.width-margin), y:clamp(y2, margin, box.height-margin)};
  state.p3 = {x:x3,y:y3};

  state.segT = 0;

  // speed in px/s -> duration
  const speed = rand(120, 260);
  state.segDur = clamp(d / speed, 1.3, 4.2);

  // pause at end sometimes
  state.pause = Math.random() < 0.65 ? rand(0.12, 0.55) : 0;
}

function bezier(p0,p1,p2,p3,t){
  const u = 1-t;
  const tt = t*t, uu=u*u;
  const uuu=uu*u, ttt=tt*t;
  return {
    x: uuu*p0.x + 3*uu*t*p1.x + 3*u*tt*p2.x + ttt*p3.x,
    y: uuu*p0.y + 3*uu*t*p1.y + 3*u*tt*p2.y + ttt*p3.y
  };
}

function bezierDeriv(p0,p1,p2,p3,t){
  const u = 1-t;
  return {
    x: 3*u*u*(p1.x-p0.x) + 6*u*t*(p2.x-p1.x) + 3*t*t*(p3.x-p2.x),
    y: 3*u*u*(p1.y-p0.y) + 6*u*t*(p2.y-p1.y) + 3*t*t*(p3.y-p2.y)
  };
}

function setFly(px, py, angleDeg){
  // place within poster coordinates (NOT page coords)
  // because #fly is inside .poster (absolute relative to poster)
  const bob = Math.sin(performance.now() * 0.02) * 2.0;
  flyEl.style.left = `${px}px`;
  flyEl.style.top  = `${py + bob}px`;
  flyEl.style.transform = `translate(-50%,-50%) rotate(${angleDeg}deg)`;
}

function tick(now){
  const dt = Math.min(0.05, (now - state.lastTime) / 1000);
  state.lastTime = now;

  const box = getPosterBox();
  if(box.width < 10 || box.height < 10){
    requestAnimationFrame(tick);
    return;
  }

  if(!state.p0) makeSegment();

  if(state.pause > 0){
    state.pause -= dt;
    // during pause: stop frames sometimes (flies pause)
    if(state.pause > 0.15) flyEl.style.animationPlayState = "paused";
    else flyEl.style.animationPlayState = "running";
  }else{
    flyEl.style.animationPlayState = "running";
    state.segT += dt / state.segDur;

    if(state.segT >= 1){
      // end of segment
      state.x = state.p3.x / box.width;
      state.y = state.p3.y / box.height;
      makeSegment();
    }
  }

  // evaluate position + heading
  const t = clamp(state.segT, 0, 1);
  const p = bezier(state.p0, state.p1, state.p2, state.p3, t);
  const d = bezierDeriv(state.p0, state.p1, state.p2, state.p3, t);

  // heading: sprite drawn "facing up", so add +90° to dx/dy direction
  let ang = Math.atan2(d.y, d.x) * 180 / Math.PI + 90;

  // small jitter
  ang += Math.sin(now*0.003) * 3.5;

  setFly(p.x, p.y, ang);

  requestAnimationFrame(tick);
}

requestAnimationFrame(tick);

// regenerate path on resize (responsive poster)
window.addEventListener("resize", ()=>{
  state.p0 = null;
});
</script>

</body>
</html>
